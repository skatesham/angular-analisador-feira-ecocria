<p-toast position="bottom-right" />
<p-confirmDialog [style]="{ width: '450px' }" [baseZIndex]="10000" styleClass="headless-confirm" />

<div class="min-h-screen bg-surface-50 dark:bg-surface-950 py-8 md:py-12">
  <div class="container mx-auto px-4 md:px-6">
    <!-- Header com Filtros de Tempo -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold text-surface-900 dark:text-surface-0 mb-2">
          Análise de Vendas - Feira da Ecocria
        </h1>
        <p class="text-surface-600 dark:text-surface-300">
          {{ totalFeiras() }} feira(s) • {{ totalItens() }} itens vendidos
        </p>
      </div>
      <div class="flex gap-2">
        <p-button 
          label="Voltar" 
          icon="pi pi-arrow-left"
          [outlined]="true"
          (onClick)="voltarParaAnalisador()"
        />
        <p-button 
          label="Salvar" 
          icon="pi pi-save"
          [outlined]="true"
          (onClick)="salvarAnalise()"
        />
        <p-button 
          label="Exportar" 
          icon="pi pi-download"
          [outlined]="true"
          (onClick)="exportarCsvCompleto()"
        />
      </div>
    </div>

    <!-- Filtros de Tempo (Single Click) -->
    <div class="mb-8">
      <p-card>
        <div class="flex flex-wrap gap-3 items-center">
          <span class="text-sm font-semibold text-surface-700 dark:text-surface-200">Período:</span>
          <p-button 
            label="Última Semana" 
            [outlined]="filtroTempo() !== 'ultima-semana'"
            size="small"
            (onClick)="aplicarFiltroTempo('ultima-semana')"
          />
          <p-button 
            label="Último Mês" 
            [outlined]="filtroTempo() !== 'ultimo-mes'"
            size="small"
            (onClick)="aplicarFiltroTempo('ultimo-mes')"
          />
          <p-button 
            label="Últimos 3 Meses" 
            [outlined]="filtroTempo() !== 'ultimos-3-meses'"
            size="small"
            (onClick)="aplicarFiltroTempo('ultimos-3-meses')"
          />
          <p-button 
            label="Tudo" 
            [outlined]="filtroTempo() !== 'tudo'"
            size="small"
            (onClick)="aplicarFiltroTempo('tudo')"
          />
        </div>
      </p-card>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
      @for (kpi of kpis(); track kpi.label) {
        <div 
          pAnimateOnScroll 
          enterClass="animate-enter fade-in-10 zoom-in-50 animate-duration-1000"
          class="bg-surface-0 dark:bg-surface-900 rounded-xl p-6 border border-surface-200 dark:border-surface-700"
        >
          <div class="flex items-center justify-between mb-3">
            <i [class]="'pi ' + kpi.icone + ' text-2xl text-primary'"></i>
          </div>
          <div class="text-3xl font-bold text-surface-900 dark:text-surface-0 mb-1">
            @if (kpi.formato === 'moeda') {
              R$ {{ kpi.valor | number:'1.2-2' }}
            } @else if (kpi.formato === 'percentual') {
              {{ kpi.valor | number:'1.1-1' }}%
            } @else {
              {{ kpi.valor }}
            }
          </div>
          <div class="text-sm text-surface-600 dark:text-surface-300">
            {{ kpi.label }}
          </div>
        </div>
      }
    </div>

    <!-- Insights "O que isso sugere" -->
    @if (insights().length > 0) {
      <div 
        pAnimateOnScroll 
        enterClass="animate-enter fade-in-10 slide-in-from-t-20 animate-duration-1000"
        class="mb-8"
      >
        <p-card>
          <ng-template pTemplate="header">
            <div class="p-4 border-b border-surface-200 dark:border-surface-700">
              <h2 class="text-2xl font-bold text-surface-900 dark:text-surface-0 flex items-center gap-2">
                <i class="pi pi-lightbulb text-yellow-500"></i>
                O que isso sugere
              </h2>
            </div>
          </ng-template>
          
          <div class="space-y-4">
            @for (insight of insights(); track $index) {
              <div class="flex gap-4 p-4 rounded-lg bg-surface-50 dark:bg-surface-800">
                <div class="flex-shrink-0">
                  <p-tag 
                    [value]="insight.tipo" 
                    [severity]="getSeveridadeInsight(insight.tipo)"
                  />
                </div>
                <div class="flex-1">
                  <h3 class="font-semibold text-surface-900 dark:text-surface-0 mb-1">
                    {{ insight.titulo }}
                  </h3>
                  <p class="text-surface-700 dark:text-surface-200 mb-2">
                    {{ insight.descricao }}
                  </p>
                  <p class="text-sm text-surface-500 dark:text-surface-400">
                    <i class="pi pi-info-circle mr-1"></i>
                    {{ insight.explicacao }}
                  </p>
                </div>
              </div>
            }
          </div>
        </p-card>
      </div>
    }

    <!-- Gráficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Top Produtos -->
      <div 
        pAnimateOnScroll 
        enterClass="animate-enter fade-in-10 slide-in-from-l-8 animate-duration-1000"
      >
        <p-card>
          <ng-template pTemplate="header">
            <div class="p-4 border-b border-surface-200 dark:border-surface-700">
              <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0">
                Top 5 Categorias
              </h3>
            </div>
          </ng-template>
          <div echarts [options]="graficoTopCategorias()" [theme]="echartsTheme()" class="h-96"></div>
        </p-card>
      </div>

      <!-- Top Subcategorias -->
      <div 
        pAnimateOnScroll 
        enterClass="animate-enter fade-in-10 slide-in-from-r-8 animate-duration-1000"
      >
        <p-card>
          <ng-template pTemplate="header">
            <div class="p-4 border-b border-surface-200 dark:border-surface-700">
              <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0">
                Top 10 Subcategorias
              </h3>
            </div>
          </ng-template>
          <div echarts [options]="graficoTopSubcategorias()" [theme]="echartsTheme()" class="h-96"></div>
        </p-card>
      </div>
    </div>

    <!-- Evolução Temporal -->
    <div 
      pAnimateOnScroll 
      enterClass="animate-enter fade-in-10 slide-in-from-b-20 animate-duration-1000"
      class="mb-8"
    >
      <p-card>
        <ng-template pTemplate="header">
          <div class="p-4 border-b border-surface-200 dark:border-surface-700">
            <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0">
              Evolução de Vendas por Data
            </h3>
          </div>
        </ng-template>
        <div echarts [options]="graficoEvolucao()" [theme]="echartsTheme()" class="h-96"></div>
      </p-card>
    </div>

    <!-- Tabela de Todas as Vendas -->
    <div 
      pAnimateOnScroll 
      enterClass="animate-enter fade-in-10 animate-duration-1000"
    >
      <p-card>
        <ng-template pTemplate="header">
          <div class="p-4 border-b border-surface-200 dark:border-surface-700">
            <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-4">
              Todas as Vendas
            </h3>
            
            <!-- Filtros da Tabela -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-medium text-surface-700 dark:text-surface-200 mb-2">
                  Data Início
                </label>
                <p-datepicker 
                  [(ngModel)]="filtroTabelaDataInicio"
                  [showIcon]="true"
                  placeholder="Selecione"
                  styleClass="w-full"
                />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-surface-700 dark:text-surface-200 mb-2">
                  Data Fim
                </label>
                <p-datepicker 
                  [(ngModel)]="filtroTabelaDataFim"
                  [showIcon]="true"
                  placeholder="Selecione"
                  styleClass="w-full"
                />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-surface-700 dark:text-surface-200 mb-2">
                  Categoria
                </label>
                <p-select 
                  [(ngModel)]="filtroTabelaCategoria"
                  [options]="categoriasDisponiveis()"
                  placeholder="Todas"
                  styleClass="w-full"
                  [showClear]="true"
                />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-surface-700 dark:text-surface-200 mb-2">
                  Buscar Nome
                </label>
                <input 
                  pInputText 
                  [(ngModel)]="filtroTabelaNome"
                  placeholder="Nome do item"
                  class="w-full"
                />
              </div>
            </div>
          </div>
        </ng-template>
        
        <p-table 
          [value]="vendasDetalhadas()" 
          [paginator]="true" 
          [rows]="10"
          [rowsPerPageOptions]="[10, 25, 50, 100]"
          [tableStyle]="{ 'min-width': '60rem' }"
          styleClass="p-datatable-sm"
          [sortField]="'receita'"
          [sortOrder]="-1"
        >
          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="data">Data <p-sortIcon field="data" /></th>
              <th pSortableColumn="categoria">Categoria <p-sortIcon field="categoria" /></th>
              <th pSortableColumn="subcategoria">Subcategoria <p-sortIcon field="subcategoria" /></th>
              <th pSortableColumn="nome">Nome <p-sortIcon field="nome" /></th>
              <th class="text-right" pSortableColumn="quantidade">Qtd <p-sortIcon field="quantidade" /></th>
              <th class="text-right" pSortableColumn="receita">Receita <p-sortIcon field="receita" /></th>
              <th class="text-right" pSortableColumn="precoUnitario">Preço Unit. <p-sortIcon field="precoUnitario" /></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-venda>
            <tr>
              <td>{{ venda.data | date:'dd/MM/yyyy' }}</td>
              <td>
                <p-tag [value]="venda.categoria || '-'" [severity]="'info'" />
              </td>
              <td>{{ venda.subcategoria || '-' }}</td>
              <td>{{ venda.nome }}</td>
              <td class="text-right">{{ venda.quantidade }}</td>
              <td class="text-right">R$ {{ venda.receita | number:'1.2-2' }}</td>
              <td class="text-right">R$ {{ venda.precoUnitario | number:'1.2-2' }}</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </div>
  </div>
</div>
